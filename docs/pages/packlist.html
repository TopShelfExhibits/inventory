<div id="tabSystem">
</div>

<script type="module">
    import { TabManager, GoogleSheetsService, GoogleSheetsAuth, TableManager, ModalManager, SPREADSHEET_IDS } from './js/index.js';

    function buildPackListTable(content) {
        const mainTableData = content.crates.map(crate => {
            const itemData = document.createElement('div');
            itemData.classList.add('table-wrapper');
            if (crate.items.length > 0) {
                const itemTable = TableManager.buildTable(
                    crate.items,
                    content.headers.items,
                    ['Pack', 'Check'],
                    [],
                    'pack-list-items',
                    ['.tab-button']
                );
                itemData.appendChild(itemTable);
            }
            return [...crate.info, itemData];
        });
        
        const headers = [...content.headers.main, 'Items'];
        return TableManager.buildTable(mainTableData, headers, [], [], 'pack-list', ['.tab-button']);
    }

    async function checkPackListQuantities(tabName, container) {
        try {
            const quantityData = await GoogleSheetsService.checkItemQuantities(tabName);
            // Dynamically get headers from the first entry in the map
            const firstEntry = Object.values(quantityData)[0] || {};
            const headers = ['Item', ...Object.keys(firstEntry).filter(key => key !== 'status'), 'Status'];
            const rows = Object.entries(quantityData).map(([itemId, info]) => {
                const status = info.remaining > 0 ? 'OK' : 'Warning';
                const statusCell = document.createElement('span');
                statusCell.textContent = status;
                statusCell.style.color = status === 'OK' ? 'green' : 'red';
                
                return [
                    itemId,
                    info.inventory,
                    info.requested,
                    info.overlapping,
                    info.remaining, // was info.available
                    statusCell
                ];
            });

            const table = TableManager.buildTable(rows, headers);
            table.classList.add('quantity-check-table');
            
            // Create a div to hold the table with a logical heading
            const inventoryReportContainer = document.createElement('div');
            const heading = document.createElement('h2');
            heading.textContent = `Inventory report for "${tabName}" pack list:`;
            inventoryReportContainer.classList.add('inventory-report-container');
            inventoryReportContainer.appendChild(heading);
            inventoryReportContainer.appendChild(table);
            container.appendChild(inventoryReportContainer);

            // For each inventory item with an error, find the pack list table and scan for
            // the corresponding item to highlight it
            // Find error items from rows (statusCell.textContent !== 'OK')
            console.log('Highlighting error items in pack list table...');
            rows.forEach(row => {
                const itemId = row[0];
                const remaining = row[4];
                const statusCell = row[row.length - 1];
                if (remaining < 0) {
                    // Insufficient inventory: red
                    const packListItems = container.querySelectorAll('.drag-id-pack-list-items td');
                    packListItems.forEach(packListItem => {
                        const itemRegex = /(?:\(([0-9]+)\))?\s*([A-Z]+-[0-9]+[a-zA-Z]?)/;
                        const match = packListItem.textContent.match(itemRegex);
                        if (match && match[2] === itemId) {
                            TableManager.tableCellWarning(packListItem, 'insufficient inventory', '.red', '.inventory-report-container');
                        }
                    });
                } else if (remaining === 0) {
                    // No inventory margin: yellow
                    const packListItems = container.querySelectorAll('.drag-id-pack-list-items td');
                    packListItems.forEach(packListItem => {
                        const itemRegex = /(?:\(([0-9]+)\))?\s*([A-Z]+-[0-9]+[a-zA-Z]?)/;
                        const match = packListItem.textContent.match(itemRegex);
                        if (match && match[2] === itemId) {
                            TableManager.tableCellWarning(packListItem, 'no inventory margin', '.yellow', '.inventory-report-container');
                        }
                    });
                }
            });

        } catch (err) {
            console.error('Error building quantity check table:', err && err.stack ? err.stack : err);
            ModalManager.alert('Failed to check item quantities.');
        }
    }

    // Extracted function to build the tabs-list DOM element from a list of sheetTabs
    function buildTabsListElement(sheetTabs) {
        const tabsList = document.createElement('div');
        tabsList.className = 'tabs-list';
        for (const tabName of sheetTabs) {
            if (tabName === 'TEMPLATE') continue;
            const tabButton = document.createElement('button');
            tabButton.classList.add('tab-button');
            tabButton.textContent = tabName;
            tabsList.appendChild(tabButton);
            tabButton.addEventListener('click', async () => {
                
                try {
                    const content = await GoogleSheetsService.getPackListContent(tabName);
                    const tabContainer = document.createElement('div');
                    const packListTable = buildPackListTable(content);
                    tabContainer.appendChild(packListTable);

                    // Asynchronously check item quantities
                    checkPackListQuantities(tabName, tabContainer);

                    TabManager.addNewTab('tabSystem', tabName, tabContainer, true, true);
                } catch (error) {
                    console.error('Error loading sheet content:', error);
                    ModalManager.alert('Failed to load spreadsheet content');
                }
                // Remove modal if present
                const modal = document.querySelector('.modal');
                if (modal) modal.remove();
            });
        }
        return tabsList;
    }

    // Standalone function for TabManager tab handler
    function addNewPackListTab() {
        GoogleSheetsAuth.checkAuth();

        const modal = ModalManager.createModal(`
            <p class="loading-message">Loading...</p>
        `);

        const loadingModal = ModalManager.showLoadingIndicator('Fetching and analyzing pack list...');
        try {
            const sheetTabs = GoogleSheetsService.getSheetTabs(SPREADSHEET_IDS.PACK_LISTS).then((sheetTabs) => {
                const tabsListElement = buildTabsListElement(sheetTabs);
                const modalBody = modal.querySelector('.modal-body');
                modalBody.innerHTML = '';
                modalBody.appendChild(tabsListElement);
            });
            loadingModal.hide();
        } catch (error) {
            console.error('Error loading sheet tabs:', error);
            loadingModal.hide();
            buildPage('<p class="error">Failed to load spreadsheet tabs</p>', modal.querySelector('.modal-body'));
        }
    }

    // Initialize the TabManager with tab handler
    TabManager.buildTabSystem('tabSystem', addNewPackListTab);


</script>